---
title: "Capstone Project Report"
subtitle: "Ambient Air Quality Anaysis"
author: "Ochea Ikpa"
date: today
format:
  html:
    toc: true
    code-fold: true
execute: 
  echo: true
  warning: false
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
# Load libraries
library(tidyverse)
library(readxl)
library(here)
library(dplyr)
library(readr)
library(ggthemes)
library(ggridges)
library(ggplot2)
library(gt)
library(knitr)
library(stringr)
library(lubridate)
library(broom)
library(scales)
library(sf)   
library(janitor)
library(stringr)
library(gt)
library(gtsummary)
library(DT)
```

```{r}
# import raw data

ambient_air <- read_excel(here::here("data/raw/who_ambient_air_quality_database_version_2024_(v6.1).xlsx"), sheet = "Update 2024 (V6.1)")
```

```{r}
#  Process raw data (data transformation)

air_quality <- ambient_air |>
  clean_names() |> # cleaning and standardizing name
  rename_with(~ gsub("\\s+", "_", .x)) |> # dobulechecking by replacing spaces with "_"
  rename(region = who_region,
         country = country_name,
         pm10 = pm10_concentration,
         pm25 = pm25_concentration,
         no2 = no2_concentration,
         station = type_of_stations) |> # reanmming variable names
  mutate(region = recode(region, 
                         `1_Afr` = "AF", 
                         `2_Amr` = "AM", 
                         `3_Sear` = "SEA", 
                         `4_Eur` = "EU", 
                         `5_Emr` = "EM", 
                         `6_Wpr` = "WP", 
                         `7_NonMS` = "NonMS")) |>
  mutate(city = str_remove(city, "/[A-Z]{3}$")) |>
  mutate(across(c(pm10, pm25, no2, population),
                as.numeric), year = as.integer(year), city = factor(city)) |>
    filter(!is.na(pm10) & 
         !is.na(pm25) & 
         !is.na(no2) & !is.na(year) & !is.na(population)) |>
  select(region:year,
         pm10:no2, # selcting relevant columns for analysis
         station,
         population) |>
      arrange(region, country, city, year)
```

```{r}
#| eval: true
#| echo: false
# applying conditinal statement: case_when() together with mutate() as an alternative

air_quality_alt <- ambient_air |>
  clean_names() |> # cleaning and standardizing name
  rename_with(~ gsub("\\s+", "_", .x)) |> # dobulechecking by replacing spaces with "_"
  rename(region = who_region,
         country = country_name,
         pm10 = pm10_concentration,
         pm25 = pm25_concentration,
         no2 = no2_concentration,
         station = type_of_stations) |> # reanmming variable names
    mutate(region = case_when(
     region == "1_Afr" ~ "AF", 
     region == "2_Amr" ~ "AM",
     region == "3_Sear" ~ "SEA",
     region == "4_Eur" ~ "EU",
     region == "5_Emr" ~ "EM",
     region == "6_Wpr" ~ "WP",
     region == "7_NonMS" ~ "NonMS"
  )) |>
  mutate(city = str_remove(city, "/[A-Z]{3}$")) |>
  mutate(across(c(pm10, pm25, no2, population),
                as.numeric), year = as.integer(year), city = factor(city)) |>
    filter(!is.na(pm10) & 
         !is.na(pm25) & 
         !is.na(no2) & !is.na(year) & !is.na(population)) |>
  select(region:year,
         pm10:no2, # selcting relevant columns for analysis
         station,
         population) |>
      arrange(region, country, city, year)
```

```{r}
# export processed data

write_csv(air_quality,
           here::here("data/processed/who_ambient_air_quality_database_version_2024_(v6.1)_processed.csv"))
```

## Note: \*\*\*\*\*"Create ReadMe & Dictionary files"

*church*

**Worship**

> `Berlin, Hamburg, Stuttgart, and Munich have been selected because they represent Germany’s largest and most diverse metropolitan regions, with distinct emission profiles, geographical settings, and climatic conditions that influence ambient air quality. They also maintain long-term, high-quality air monitoring networks, making them ideal for robust descriptive statistical analysis, trend analysis and inter-city comparison of PM₂.₅, PM₁₀, and NO₂ levels from 2010 t0 2021`

ug/dm^3^ NO~2~

```{r}
# load dataset
air_quality

# explore dataset
glimpse(air_quality)
head(air_quality)
tail(air_quality)
str(air_quality)
nrow(air_quality)
ncol(air_quality)
```

```{r}

# analysis of processed data


```

```{r}

```

## Analysis

`Berlin, Hamburg, Stuttgart, and Munich have been selected because they represent Germany’s largest and most diverse metropolitan regions, with distinct emission profiles, geographical settings, and climatic conditions that influence ambient air quality. They also maintain long-term, high-quality air monitoring networks, making them ideal for robust descriptive statistical analysis, trend analysis and inter-city comparison of PM₂.₅, PM₁₀, and NO₂ levels from 2010 t0 2021`

```{r}
# Filter only German cities of interest

germany_cities <- c("Berlin", "Hamburg", "Munchen", "Stuttgart")

air_quality_deu <- air_quality |>
  filter(country == "Germany",
         city %in% germany_cities,
         year >= 2010 & year <= 2021)
```

### 1.0 Descriptive Statistics

```{r}

desc_stats <- air_quality_deu |>
  group_by(city) |>
  summarise(
    mean_pm25 = mean(pm25),
    sd_pm25   = sd(pm25),
    median_pm25 = median(pm25),
    mean_pm10 = mean(pm10),
    sd_pm10   = sd(pm10),
    median_pm10 = median(pm10),
    mean_no2 = mean(no2),
    sd_no2   = sd(no2),
    median_no2 = median(no2))
  
print(desc_stats)

```

```{r}
desc_stats |>
    gt() |> # Using gt() function for table presentation 
    tab_header(title = "Descriptive Statistical Analysis of Top German Cities' Ambient Air Quality (µg/m³)",
               subtitle = "Data from 2010 to 2021") |>
    fmt_number(columns = mean_pm25:sd_no2, decimals = 2) |>
    cols_label(city = "City",
               mean_pm25 = "Mean(PM₂.₅)",
               sd_pm25 = "SD(PM₂.₅)",
               median_pm25 = "Median(PM₂.₅)",
               mean_pm10 = "Mean(PM₁₀)",
               sd_pm10 = "SD(PM₁₀)",
               median_pm10 = "Median(PM₁₀)",
               mean_no2 = "Mean(NO₂)",
               sd_no2 = "SD(NO₂)",
               median_no2 = "Median(NO₂)")
```

@tbl-deu-stats `below summarises the annual mean concentrations and their variability for PM₂.₅, PM₁₀, and NO₂ across four major German cities from 2010 to 2021 and via 3 descriptive measures: Mean, Standard deviations and Median`.

`Between 2010 and 2021, Hamburg shows the cleanest air across all pollutants, while Stuttgart exhibits the highest concentrations, especially for NO₂, reflecting severe traffic-related pollution and its valley-basin geography. Berlin has the highest PM₂.₅, whereas Munich shows moderate PM but high NO₂, again linked to traffic intensity. Standard deviations confirm that Stuttgart and Munich experience the largest year-to-year fluctuations, while Berlin and Hamburg remain relatively stable`. `Overall`, @tbl-deu-stats `highlights clear spatial contrasts in air quality, shaped by urban structure, meteorology, and traffic patterns`.

```{r}
#| label: tbl-deu-stats
#| tbl-cap: "Descriptive Statistical Analysis of Top German Cities' Ambient Air Quality (µg/m³). Data from 2010 - 2021"

desc_stats |>
    rename(`City` = city,
           `Mean(PM₂.₅)` = mean_pm25,
           `SD(PM₂.₅)` = sd_pm25,
            `Median(PM₂.₅)` = median_pm25,
           `Mean(PM₁₀)` = mean_pm10,
           `SD(PM₁₀)` = sd_pm10,
           `Median(PM₁₀)` = median_pm10,
           `Mean(NO₂)` = mean_no2,
           `SD(NO₂)` = sd_no2,
           `Median(NO₂)` = median_no2) |>
    kable(digits = 2) # Using kable() function table presenation and cross-referencing
```

### Time Series Plots

```{r}
ggplot(air_quality_deu,
       aes(year,
           pm25,
           color = city)) +
  geom_line(size = 1.1) +
  geom_point() +
  theme_minimal() +
  labs(title = "PM2.5 Trend (2010–2021)", y = "PM2.5 (µg/m³)")

ggplot(air_quality_deu,
       aes(year,
           pm10,
           color = city)) +
  geom_line(size = 1.1) +
  geom_point() +
  theme_minimal() +
  labs(title = "PM10 Trend (2010–2021)", y = "PM10 (µg/m³)")

ggplot(air_quality_deu,
       aes(year,
           no2,
           color = city)) +
  geom_line(size = 1.1) +
  geom_point() +
  theme_minimal() +
  labs(title = "NO₂ Trend (2010–2021)", y = "NO₂ (µg/m³)")
```

Trend Analysis

### Rate of Change per year (using linear regression slope)

```{r}
compute_slope <- function(air_quality_deu, pollutant) {
  model <- lm(air_quality_deu[[pollutant]] ~ air_quality_deu$year)
  slope <- coef(model)[2]  # yearly rate of change
  return(slope)
}

slopes <- air_quality_deu |>
  group_by(city) |>
  summarise(
    slope_pm25 = compute_slope(cur_data(), "pm25"),
    slope_pm10 = compute_slope(cur_data(), "pm10"),
    slope_no2  = compute_slope(cur_data(), "no2")
  )

print(slopes)
```

### Precentage Change (first year vs last year)

```{r}
percent_change <- air_quality_deu |>
  group_by(city) |>
  summarise(
    pct_pm25 = ((last(pm25) - first(pm25)) / first(pm25)) * 100,
    pct_pm10 = ((last(pm10) - first(pm10)) / first(pm10)) * 100,
    pct_no2  = ((last(no2) - first(no2))  / first(no2) * 100)
  )

print(percent_change)
```

### Correlation Matrix

```{r}
# Computing correlation matrix
corr_data <- air_quality_deu |>
  select(pm25, pm10, no2)

corr_matrix <- cor(corr_data, use = "complete.obs")
print(corr_matrix)

# Converting matrix to tidy format for ggplot
corr_air_quality_deu <- corr_matrix |>
  as.data.frame() |>
  rownames_to_column("var1") |>
  pivot_longer(cols = -var1, names_to = "var2", values_to = "value")

# Plotting heatmap
ggplot(corr_air_quality_deu,
       aes(var1, var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(value, 2)), size = 5) +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  theme_minimal() +
  labs(title = "Correlation Heatmap", x = "", y = "")
```

### **PCA (Principal Component Analysis)**

```{r}
pca_input <- air_quality_deu |>
  select(pm25, pm10, no2) |>
  scale()

pca <- prcomp(pca_input)

summary(pca)
plot(pca, main = "PCA Scree Plot")
biplot(pca, cex = 0.6, main = "PCA Biplot")
```

```{r}
# Plotting PCA without labels
plot(pca$x[,1], pca$x[,2],
     xlab = "PC1", ylab = "PC2",
     main = "PCA Biplot (clean)",
     pch = 19, col = "grey40")

# Adding variable arrows
arrows(0, 0, pca$rotation[,1] * 3, pca$rotation[,2] * 3,
       col = "red", lwd = 2)

# Adding variable names with spacing
text(pca$rotation[,1] * 3.2,
     pca$rotation[,2] * 3.2,
     labels = rownames(pca$rotation),
     col = "red", cex = 1)

```

### K-Means Clustering

```{r}
set.seed(123)
k3 <- kmeans(pca_input, centers = 3)

air_quality_deu$cluster <- k3$cluster

ggplot(air_quality_deu,
       aes(pm25,
           pm10,
           color = as.factor(cluster))) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(title = "K-means Clustering (3 clusters)", color = "Cluster")
```
